# .github/workflows/property-automation.yml
# ë‹¤ì¤‘ ë§¤ë¬¼ ì²˜ë¦¬ìš© ë©”ì¸ ìžë™í™” ì›Œí¬í”Œë¡œìš°

name: Property Automation

# Git Push ê¶Œí•œ ì¶”ê°€
permissions:
  contents: write

on:
  # ë§¤ì¼ ìžì • 1ë¶„ì— ìžë™ ì‹¤í–‰
  schedule:
    - cron: '1 15 * * *'  # UTC 15:01 = KST 00:01

  # ìˆ˜ë™ ì‹¤í–‰ (í…ŒìŠ¤íŠ¸ìš©)
  workflow_dispatch:
    inputs:
      property_numbers:
        description: 'ë§¤ë¬¼ë²ˆí˜¸ë“¤ (ì½¤ë§ˆë¡œ êµ¬ë¶„, ì„ íƒì‚¬í•­)'
        required: false
        default: ''
      test_mode:
        description: 'í…ŒìŠ¤íŠ¸ ëª¨ë“œ'
        required: false
        default: 'false'
        type: choice
        options:
        - 'true'
        - 'false'

jobs:
  check-schedule:
    runs-on: ubuntu-latest
    outputs:
      has_schedule: ${{ steps.check.outputs.has_schedule }}
      property_count: ${{ steps.check.outputs.property_count }}
      properties: ${{ steps.check.outputs.properties }}
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
    
    - name: Check for scheduled properties
      id: check
      run: |
        if [ -f "data/scheduled_properties.json" ]; then
          echo "has_schedule=true" >> $GITHUB_OUTPUT
          
          # JSONì—ì„œ ë§¤ë¬¼ ì •ë³´ ì¶”ì¶œ
          properties=$(cat data/scheduled_properties.json | jq -r '.properties | join(",")')
          count=$(cat data/scheduled_properties.json | jq -r '.total_count')
          
          echo "properties=${properties}" >> $GITHUB_OUTPUT
          echo "property_count=${count}" >> $GITHUB_OUTPUT
          
          echo "ðŸ“‹ ì˜ˆì•½ëœ ë§¤ë¬¼ ë°œê²¬: ${count}ê°œ"
          echo "ðŸ“Š ë§¤ë¬¼ë²ˆí˜¸: ${properties}"
        else
          echo "has_schedule=false" >> $GITHUB_OUTPUT
          echo "ðŸ“ ì˜ˆì•½ëœ ë§¤ë¬¼ ì—†ìŒ"
        fi

  automation:
    needs: check-schedule
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright/python:v1.55.0-noble
    if: needs.check-schedule.outputs.has_schedule == 'true' || github.event.inputs.property_numbers != ''
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Install Python dependencies
      run: |
        python -m pip install --upgrade pip
        pip install playwright
        echo "âœ… Playwright íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì™„ë£Œ (ë¸Œë¼ìš°ì €ì™€ ì‹œìŠ¤í…œ ì˜ì¡´ì„±ì€ ì»¨í…Œì´ë„ˆì— ì‚¬ì „ ì„¤ì¹˜ë¨)"
    
    - name: Determine property numbers
      id: properties
      run: |
        if [ -n "${{ github.event.inputs.property_numbers }}" ]; then
          # ìˆ˜ë™ ìž…ë ¥ëœ ë§¤ë¬¼ë²ˆí˜¸ ì‚¬ìš©
          echo "properties=${{ github.event.inputs.property_numbers }}" >> $GITHUB_OUTPUT
          echo "source=manual" >> $GITHUB_OUTPUT
        else
          # ì˜ˆì•½ íŒŒì¼ì—ì„œ ë§¤ë¬¼ë²ˆí˜¸ ì‚¬ìš©
          echo "properties=${{ needs.check-schedule.outputs.properties }}" >> $GITHUB_OUTPUT
          echo "source=scheduled" >> $GITHUB_OUTPUT
        fi
    
    - name: Run multi-property automation
      run: |
        echo "ðŸš€ ë‹¤ì¤‘ ë§¤ë¬¼ ìžë™í™” ì‹œìž‘..."
        echo "ðŸ“‹ ì²˜ë¦¬í•  ë§¤ë¬¼: ${{ steps.properties.outputs.properties }}"
        echo "ðŸ“Š ë§¤ë¬¼ ê°œìˆ˜: $(echo '${{ steps.properties.outputs.properties }}' | tr ',' '\n' | wc -l)"
        echo "ðŸ”§ í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ${{ github.event.inputs.test_mode || 'false' }}"
        
        python multi_property_automation.py
      env:
        LOGIN_ID: ${{ secrets.LOGIN_ID }}
        LOGIN_PASSWORD: ${{ secrets.LOGIN_PASSWORD }}
        PROPERTY_NUMBERS: ${{ steps.properties.outputs.properties }}
        TEST_MODE: ${{ github.event.inputs.test_mode || 'false' }}
        TZ: Asia/Seoul
    
    - name: Delete completed schedule
      if: always() && steps.properties.outputs.source == 'scheduled'
      run: |
        if [ -f "data/scheduled_properties.json" ]; then
          rm data/scheduled_properties.json
          echo "ðŸ—‘ï¸ ì˜ˆì•½ íŒŒì¼ ì‚­ì œ ì™„ë£Œ: scheduled_properties.json"
        else
          echo "ðŸ“ ì‚­ì œí•  ì˜ˆì•½ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
        fi

    - name: Create execution log
      if: always()
      run: |
        timestamp=$(date +"%Y%m%d_%H%M%S")
        mkdir -p results
        
        cat > results/execution_${timestamp}.json << EOF
        {
          "executed_at": "$(date -Iseconds)",
          "properties": "${{ steps.properties.outputs.properties }}",
          "property_count": $(echo '${{ steps.properties.outputs.properties }}' | tr ',' '\n' | wc -l),
          "test_mode": "${{ github.event.inputs.test_mode || 'false' }}",
          "source": "${{ steps.properties.outputs.source }}",
          "status": "completed"
        }
        EOF
        
        echo "ðŸ“ ì‹¤í–‰ ë¡œê·¸ ìƒì„±: results/execution_${timestamp}.json"
    
    - name: Commit results
      if: always()
      run: |
        # Docker ì»¨í…Œì´ë„ˆì—ì„œ Git ë¦¬í¬ì§€í† ë¦¬ ì¸ì‹ (ë™ì  ê²½ë¡œ ì‚¬ìš©)
        git config --global --add safe.directory $GITHUB_WORKSPACE
        git config --global user.email "action@github.com"
        git config --global user.name "GitHub Action"

        # ë³€ê²½ì‚¬í•­ í™•ì¸
        git status

        # Pull ë¨¼ì € ìˆ˜í–‰ (conflict ë°©ì§€)
        git pull --rebase || true

        # ìŠ¤í…Œì´ì§•
        git add results/ data/ || true

        # ì»¤ë°‹ (ë³€ê²½ì‚¬í•­ì´ ìžˆì„ ë•Œë§Œ)
        if git diff --staged --quiet; then
          echo "ðŸ“ ë³€ê²½ì‚¬í•­ ì—†ìŒ - ì»¤ë°‹ ê±´ë„ˆëœ€"
        else
          git commit -m "ðŸ¤– ìžë™í™” ì‹¤í–‰ ì™„ë£Œ $(date +"%Y-%m-%d %H:%M:%S")"
          echo "âœ… ì»¤ë°‹ ì™„ë£Œ"

          # Push (ìµœëŒ€ 3íšŒ ìž¬ì‹œë„)
          for i in 1 2 3; do
            if git push; then
              echo "âœ… Push ì„±ê³µ (ì‹œë„ $i)"
              break
            else
              echo "âš ï¸ Push ì‹¤íŒ¨ (ì‹œë„ $i) - ìž¬ì‹œë„..."
              sleep 2
              git pull --rebase || true
            fi
          done
        fi
    
    - name: Upload screenshots
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-screenshots-${{ github.run_number }}
        path: "*.png"
        retention-days: 7
    
    - name: Upload logs
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: automation-logs-${{ github.run_number }}
        path: |
          *.log
          results/
        retention-days: 30

  no-schedule:
    needs: check-schedule
    runs-on: ubuntu-latest
    if: needs.check-schedule.outputs.has_schedule == 'false' && github.event.inputs.property_numbers == ''
    
    steps:
    - name: No automation needed
      run: |
        echo "â„¹ï¸ ì‹¤í–‰í•  ìžë™í™” ìž‘ì—…ì´ ì—†ìŠµë‹ˆë‹¤."
        echo ""
        echo "ðŸ“‹ ì˜ˆì•½ëœ ë§¤ë¬¼: ì—†ìŒ"
        echo "ðŸ“ ìˆ˜ë™ ìž…ë ¥: ì—†ìŒ"
        echo ""
        echo "ðŸ’¡ ë§¤ë¬¼ì„ ì˜ˆì•½í•˜ë ¤ë©´:"
        echo "1. PC GUIì—ì„œ ë§¤ë¬¼ ì„ íƒ"
        echo "2. GitHubì— scheduled_properties.json ì—…ë¡œë“œ"
        echo "3. ë‹¤ìŒ ìžì •ì— ìžë™ ì‹¤í–‰ë¨"
